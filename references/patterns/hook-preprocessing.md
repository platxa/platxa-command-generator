# Hook Preprocessing Pattern

How hooks can filter command output to reduce context window consumption.

## Problem

When commands execute tools like `Bash`, the full output enters Claude's context window. A test suite with 500 passing tests and 2 failures sends all 500 results into context, wasting tokens on information Claude doesn't need.

## Solution: PostToolUse Hooks

Claude Code hooks can intercept tool results and filter them before they enter the context window. Use `PostToolUse` hooks to strip noise and surface only actionable information.

## Example: Filter Test Output to Failures Only

`.claude/settings.json`:

```json
{
  "hooks": {
    "PostToolUse": [
      {
        "matcher": "Bash",
        "command": "python3 .claude/hooks/filter-test-output.py"
      }
    ]
  }
}
```

`.claude/hooks/filter-test-output.py`:

```python
#!/usr/bin/env python3
"""Filter pytest output to show only failures and summary."""
import sys
import json

input_data = json.loads(sys.stdin.read())
output = input_data.get("stdout", "")

# Only filter pytest output
if "pytest" not in input_data.get("command", ""):
    print(json.dumps(input_data))
    sys.exit(0)

lines = output.split("\n")
filtered = []
in_failure = False

for line in lines:
    if line.startswith("FAILED") or line.startswith("ERROR"):
        in_failure = True
    if in_failure:
        filtered.append(line)
    if line.startswith("=") and "passed" in line:
        filtered.append(line)

input_data["stdout"] = "\n".join(filtered) if filtered else output
print(json.dumps(input_data))
```

**Before**: 500 lines of test output in context.
**After**: Only failed tests and summary line.

## Other Preprocessing Use Cases

| Hook | Filters | Benefit |
|------|---------|---------|
| Filter `git log` output | Strip merge commits, show only subject lines | Reduce git history noise |
| Filter `ls`/`find` output | Exclude `node_modules`, `.git`, build dirs | Focus on source files |
| Filter lint output | Show only errors, hide warnings | Prioritize actionable items |
| Truncate large file reads | Cap output at N lines with "truncated" note | Prevent context overflow |

## When to Recommend Hooks

Commands generated by this tool should suggest hook preprocessing when:

- The command runs tools that produce verbose output (test suites, linters, builds)
- The command processes many files where only a subset is relevant
- The workflow involves iterative runs where previous output is no longer needed

Add a note in the command's `## Verification` section:

```markdown
## Verification

**Tip**: Add a PostToolUse hook to filter test output to failures only.
See `.claude/hooks/` for examples.
```

## Relationship to Commands

Commands and hooks are complementary:

| Concern | Handled By |
|---------|-----------|
| What to do | Command (.md file) |
| How to filter results | Hook (settings.json + script) |
| When to block actions | PreToolUse hook |
| How to post-process | PostToolUse hook |

Commands instruct Claude what actions to take. Hooks control the environment around those actions.
